import { H as He, P as Pa, a as ae, N as Na, k as kr, u as ue, W as W$1, R as Ra, e as ea, x as xa, b as Wr, S as Sa, l as le, c as Aa, O as Oa } from './index17.mjs';
import { createMemo, createEffect, createSignal, createUniqueId, batch, getListener, onCleanup, DEV } from 'solid-js';
import { createStore, reconcile } from 'solid-js/store';
import { isServer } from 'solid-js/web';

var Le=!isServer&&DEV?{equals:false,name:"trigger"}:{equals:false},Pe=!isServer&&DEV?{equals:false,internal:true}:Le,ee=class{#e;constructor(t=Map){this.#e=new t;}dirty(t){isServer||this.#e.get(t)?.$$();}dirtyAll(){if(!isServer)for(const t of this.#e.values())t.$$();}track(t){if(!getListener())return;let e=this.#e.get(t);if(e)e.n++;else {const[a,r]=createSignal(void 0,Pe);this.#e.set(t,e={$:a,$$:r,n:1});}onCleanup(()=>{e.n--===1&&queueMicrotask(()=>e.n===0&&this.#e.delete(t));}),e.$();}};function W(t){const e=typeof t=="function"?t():t;return Object.entries(e).reduce((a,[r,v])=>(a[r]=createMemo(()=>v),a),{})}var D=Symbol("track-keys"),J=class extends Map{#e=new ee;#s=new ee;#a;#t=[];constructor(t=10,e){if(super(),this.#a=t,e)for(const[a,r]of e)this.set(a,r);}#r(t){const e=this.#t.indexOf(t);if(e>-1&&this.#t.splice(e,1),this.#t.push(t),this.#t.length>this.#a){const a=this.#t.shift();this.delete(a);}}has(t){this.#e.track(t);const e=super.has(t);return e&&this.#r(t),e}get(t){this.#s.track(t);const e=super.get(t);return e!==void 0&&this.#r(t),e}get size(){return this.#e.track(D),super.size}*keys(){for(const t of super.keys())this.#e.track(t),yield t;this.#e.track(D);}*values(){for(const[t,e]of super.entries())this.#s.track(t),yield e;this.#e.track(D);}*entries(){for(const t of super.entries())this.#s.track(t[0]),yield t;this.#e.track(D);}set(t,e){return batch(()=>{if(super.has(t)){if(super.get(t)===e){this.#r(t);return}}else this.#e.dirty(t),this.#e.dirty(D);this.#s.dirty(t),super.set(t,e),this.#r(t);}),this}delete(t){const e=super.delete(t);return e&&batch(()=>{this.#e.dirty(t),this.#e.dirty(D),this.#s.dirty(t);const a=this.#t.indexOf(t);a>-1&&this.#t.splice(a,1);}),e}clear(){super.size&&batch(()=>{for(const t of super.keys())this.#e.dirty(t),this.#s.dirty(t);super.clear(),this.#t=[],this.#e.dirty(D);});}forEach(t){this.#e.track(D);for(const[e,a]of super.entries())this.#s.track(e),this.#r(e),t(a,e,this);}[Symbol.iterator](){return this.entries()}},te=new J;function ze(t={}){const e=createMemo(()=>W(t)),a=createMemo(()=>e().experimental_prepareRequestBody?.()),r=createMemo(()=>({...e(),experimental_prepareRequestBody:a})),v=createMemo(()=>r().api?.()??"/api/chat"),w=createMemo(()=>r().generateId?.()??He),C=createMemo(()=>r().id?.()??w()()),$=createMemo(()=>`${v()}|${C()}|messages`),p=createMemo(()=>te.get($())??r().initialMessages?.()??[]),[x,L]=createStore(Pa(p()));createEffect(()=>{L(reconcile(Pa(p()),{merge:true}));});const O=s=>{te.set($(),s);},[T,l]=createSignal(void 0),[M,g]=createSignal(void 0),[f,m]=createSignal("ready");let o=Pa(p())||[];createEffect(()=>{o=Pa(p())||[];});let i=null,u={credentials:r().credentials?.(),headers:r().headers?.(),body:r().body?.()};createEffect(()=>{u={credentials:r().credentials?.(),headers:r().headers?.(),body:r().body?.()};});const R=async s=>{l(void 0),m("submitted");const c=o.length,d=le(s.messages[s.messages.length-1]?.toolInvocations);try{i=new AbortController;const S=r().streamProtocol?.()??"data",j=r().onFinish?.(),de=r().onResponse?.(),ue=r().onToolCall?.(),he=r().sendExtraMessageFields?.(),pe=r().keepLastMessageOnError?.()??!0,ge=r().experimental_prepareRequestBody?.(),fe=o,E=Pa(s.messages);O(E);const me=M()??[],ye=he?E:E.map(({role:z,content:P,experimental_attachments:q,data:G,annotations:H,toolInvocations:Q,parts:X})=>({role:z,content:P,...q!==void 0&&{experimental_attachments:q},...G!==void 0&&{data:G},...H!==void 0&&{annotations:H},...Q!==void 0&&{toolInvocations:Q},...X!==void 0&&{parts:X}}));await Aa({api:v(),body:ge?.({id:C(),messages:E,requestData:s.data,requestBody:s.body})??{id:C(),messages:ye,data:s.data,...u.body,...s.body},streamProtocol:S,credentials:u.credentials,headers:{...u.headers,...s.headers},abortController:()=>i,restoreMessagesOnFailure(){pe||O(fe);},onResponse:de,onUpdate({message:z,data:P,replaceLastMessage:q}){m("streaming"),O([...q?E.slice(0,E.length-1):E,z]),P?.length&&g([...me,...P]);},onToolCall:ue,onFinish:j,generateId:w(),fetch:r().fetch?.(),lastMessage:E[E.length-1]}),i=null,m("ready");}catch(S){if(S.name==="AbortError")return i=null,m("ready"),null;const j=r().onError?.();j&&S instanceof Error&&j(S),l(S),m("error");}const b=r().maxSteps?.()??1,I=o;Oa({originalMaxToolInvocationStep:d,originalMessageCount:c,maxSteps:b,messages:I})&&await R({messages:I});},N=async(s,{data:c,headers:d,body:b,experimental_attachments:I=s.experimental_attachments}={})=>{const S=await xa(I),j=o.concat({...s,id:s.id??w()(),createdAt:s.createdAt??new Date,experimental_attachments:S.length>0?S:void 0,parts:Wr(s)});return R({messages:j,headers:d,body:b,data:c})},y=async({data:s,headers:c,body:d}={})=>{if(o.length===0)return null;const b=o[o.length-1];return R({messages:b.role==="assistant"?o.slice(0,-1):o,headers:c,body:d,data:s})},F=()=>{i&&(i.abort(),i=null);},B=s=>{typeof s=="function"&&(s=s(o));const c=Pa(s);O(c),o=c;},K=s=>{typeof s=="function"&&(s=s(M())),g(s);},[Y,V]=createSignal(r().initialInput?.()||""),ne=async(s,c={},d)=>{s?.preventDefault?.();const b=Y();if(!b&&!c.allowEmptySubmit)return;const I=await xa(c.experimental_attachments);d&&(u={...u,...d}),R({messages:o.concat({id:w()(),role:"user",content:b,createdAt:new Date,experimental_attachments:I.length>0?I:void 0,parts:[{type:"text",text:b}]}),headers:c.headers,body:c.body,data:c.data}),V("");},ie=s=>{V(s.target.value);},ce=({toolCallId:s,result:c})=>{const d=o??[];if(Ra({messages:d,toolCallId:s,toolResult:c}),O(d),f()==="submitted"||f()==="streaming")return;const b=d[d.length-1];ea(b)&&R({messages:d});},le$1=createMemo(()=>f()==="submitted"||f()==="streaming");return {messages:()=>x,id:C(),append:N,error:T,reload:y,stop:F,setMessages:B,input:Y,setInput:V,handleInputChange:ie,handleSubmit:ne,isLoading:le$1,status:f,data:M,setData:K,addToolResult:ce}}var se=new J;function Ue(t={}){const e=createMemo(()=>W(t)),a=createMemo(()=>e().api?.()??"/api/completion"),r=createMemo(()=>e().id?.()??`completion-${createUniqueId()}`),v=createMemo(()=>`${a()}|${r()}|completion`),w=createMemo(()=>se.get(v())??e().initialCompletion?.()??""),C=y=>{se.set(v(),y);},[$,p]=createSignal(void 0),[x,L]=createSignal(void 0),[O,T]=createSignal(false),[l,M]=createSignal(null);let g={credentials:e().credentials?.(),headers:e().headers?.(),body:e().body?.()};createEffect(()=>{g={credentials:e().credentials?.(),headers:e().headers?.(),body:e().body?.()};});const f=async(y,F)=>{const B=x()??[];return Sa({api:a(),prompt:y,credentials:e().credentials?.(),headers:{...g.headers,...F?.headers},body:{...g.body,...F?.body},streamProtocol:e().streamProtocol?.(),setCompletion:C,setLoading:T,setError:p,setAbortController:M,onResponse:e().onResponse?.(),onFinish:e().onFinish?.(),onError:e().onError?.(),onData:K=>{L([...B,...K??[]]);},fetch:e().fetch?.()})},m=()=>{l()&&l().abort();},o=y=>{C(y);},[i,u]=createSignal(e().initialInput?.()??"");return {completion:w,complete:f,error:$,stop:m,setCompletion:o,input:i,setInput:u,handleInputChange:y=>{u(y.target.value);},handleSubmit:y=>{y?.preventDefault?.();const F=i();return F?f(F):void 0},isLoading:O,data:x}}var qe=()=>fetch,re=new J;function Ae(t){const e=createMemo(()=>W(t)),a=createMemo(()=>e().id?.()??`object-${createUniqueId()}`),r=createMemo(()=>re.get(a())??e().initialValue?.()),v=T=>{re.set(a(),T);},[w,C]=createSignal(),[$,p]=createSignal(false);let x=null;return {submit:async T=>{try{v(void 0),p(!0),C(void 0);const l=new AbortController;x=l;const g=await(fetch??qe())(e().api(),{method:"POST",headers:{"Content-Type":"application/json",...e().headers?.()},credentials:e().credentials?.(),signal:l.signal,body:JSON.stringify(T)});if(!g.ok)throw new Error(await g.text()??"Failed to fetch the response.");if(g.body==null)throw new Error("The response body is empty.");let f="",m;await g.body.pipeThrough(new TextDecoderStream).pipeTo(new WritableStream({write(o){f+=o;const{value:i}=kr(f),u=i;ue(m,u)||(m=u,v(u));},close(){p(!1),x=null;const o=e().onFinish?.();if(o!=null){const i=ae({value:m,schema:Na(e().schema())});o(i.success?{object:i.value,error:void 0}:{object:void 0,error:i.error});}}}));}catch(l){if(W$1(l))return;const M=e().onError?.();M&&l instanceof Error&&M(l),p(false),C(l instanceof Error?l:new Error(String(l)));}},object:r,error:w,isLoading:$,stop:()=>{try{x?.abort();}catch{}finally{p(false),x=null;}}}}var We=Ae;

export { Ue as U, We as W, ze as z };
//# sourceMappingURL=index162.mjs.map
